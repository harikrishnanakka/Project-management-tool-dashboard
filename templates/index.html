<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    {% csrf_token %}
    <title>Responsive Task Dashboard</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="{% static "app.js" %}"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <div class="left">
            <header>
                <div class="logo">
                    <h2>Harikrishna's Board</h2>
                    <div class="close">
                        <span class="material-symbols-outlined">close</span>
                    </div>
                </div>
                <nav>
                    <ul>
                        <li>
                            <a href="">
                                <span class="material-symbols-outlined full">dashboard</span>
                                <span class="title">Dashboard</span>
                            </a>
                        </li>
                      
                        <li>
                            <a href="{% url 'calender'%}">
                                <span class="material-symbols-outlined">calendar_today</span>
                                <span class="title">Calendars</span>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'payments'%}">
                                <span class="material-symbols-outlined">payment</span>
                                <span class="title">Payment Options</span>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'conversations' %}">
                                <span class="material-symbols-outlined">message</span>
                                <span class="title">Conversations</span>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'filings' %}">
                                <span class="material-symbols-outlined">folder</span>
                                <span class="title">Filing Options</span>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'settings' %}">
                                <span class="material-symbols-outlined">settings</span>
                                <span class="title">Settings</span>
                            </a>
                        </li>
                        <!-- Add more navigation items here -->
                    </ul>
                </nav>
            </header>
            <div class="upgrade">
                <h4>Upgrade to <bold>PRO</bold> for<br> more features</h4>
                <div class="upBtn">
                    <button>Upgrade</button>
                </div>
            </div>
        </div>
        <div class="right">
            <div class="top">
                <div class="searchBx">
                    <h2>Dashboard</h2>
                    <div class="inputBx">
                        <span class="material-symbols-outlined searchOpen">search</span>
                        <input type="text" placeholder="Search...">
                        <span class="material-symbols-outlined searchClose">close</span>
                    </div>
                </div>
                <div class="user">
                    <span class="material-symbols-outlined">notifications</span>
                    <div class="userImg">
                        <img src="{% static 'images/photo33.jpg' %}" alt="user">
                    </div>
                    <h2>Harikrishna<br><span>Administrator</span></h2>
                    <div class="arrow">
                        <span class="material-symbols-outlined">expand_more</span>
                    </div>
                    <div class="toggle">
                        <span class="material-symbols-outlined">menu</span>
                        <span class="material-symbols-outlined">close</span>
                    </div>
                </div>
            </div>
            <main>
                <div class="calendar">
                    <div class="calendarHead">
                        <h2 id="current-month">June 2024</h2>
                        <div class="calendarIcon">
                            <span class="material-symbols-outlined" onclick="changeMonth(-1)">chevron_left</span>
                            <span class="material-symbols-outlined" onclick="changeMonth(1)">chevron_right</span>
                        </div>
                    </div>
                    <div class="calendarData">
                        <ul class="weeks">
                            <li>Sun</li>
                            <li>Mon</li>
                            <li>Tue</li>
                            <li>Wed</li>
                            <li>Thu</li>
                            <li>Fri</li>
                            <li>Sat</li>
                        </ul>
                        <ul class="days">
                            <!-- Dates for the given month will be inserted here dynamically -->
                        </ul>
                    </div>
                </div>
                <div class="messages">
                    <div class="messageHead">
                        <h2>Today's Tasks</h2>
                        <span class="material-symbols-outlined">edit_calendar</span>
                    </div>
                    <div class="messageBox">
                        <div class="message">
                            <div class="content">
                                <h2>Meeting</h2>
                                <p>Meeting with the team</p>
                            </div>
                            <span class="material-symbols-outlined">edit</span>
                        </div>
                        <div class="message">
                            <div class="content">
                                <h2>Update</h2>
                                <p>Update project progress</p>
                            </div>
                            <span class="material-symbols-outlined">edit</span>
                        </div>
                        <div class="message">
                            <div class="content">
                                <h2>Review</h2>
                                <p>Review the new designs</p>
                            </div>
                            <span class="material-symbols-outlined">edit</span>
                        </div>
                        <div class="message">
                            <div class="content">
                                <h2>Report</h2>
                                <p>Submit the weekly report</p>
                            </div>
                            <span class="material-symbols-outlined">edit</span>
                        </div>
                    </div>
                    <form class="messageForm">
                        <input type="text" placeholder="Enter task...">
                        <button type="submit">Add Task</button>
                    </form>
                </div>
                <div id="project-progress-graph" style="width:400px;height:300px;">
                    <h5>Task completion % of Team</h5>
                </div>
                <div id="project-completion-graph" style="width:500px;height:300px;"></div>
                <div id="task-timeline" style="width:620px;height:500px;margin-top:-250px;"></div>
                    <!-- messages start -->
    <div class="messages">
        <!-- messagesHead start -->
        <div class="messagesHead">
            <h2>Messages</h2>
        </div>
        <!-- messagesHead end -->
        <!-- messagesUser start -->
        <div class="messagesUser">
            <div class="messagesUserImg">
                <img src="{% static "images/h2image.jpeg" %}" alt="img1">
            </div>
            <h2>Revanth<br><span>Pending task</span></h2>
        </div>
        <!-- messagesUser end -->
        <!-- messagesUser start -->
        <div class="messagesUser">
            <div class="messagesUserImg">
                <img src="{% static "images/h3image.jpeg" %}" alt="img2">
            </div>
            <h2>Hari<br><span>Call?</span></h2>
        </div>
        <!-- messagesUser end -->
        <!-- messagesUser start -->
        <div class="messagesUser">
            <div class="messagesUserImg">
                <img src="{% static "images/h4image.jpeg" %}" alt="img3">
            </div>
            <h2>Usha<br><span>Done!!</span></h2>
        </div>
        <!-- messagesUser end -->
        <!-- messagesUser start -->
        <div class="messagesUser">
            <div class="messagesUserImg">
                <img src="{% static "images/h5image.jpeg" %}" alt="img4">
            </div>
            <h2>pallavi<br><span>Send the doc</span></h2>
        </div>
        <!-- messagesUser end -->
        <!-- messagesUser start -->
        <div class="messagesUser">
            <div class="messagesUserImg">
                <img src="{% static "images/h1image.jpeg" %}" alt="img5">
            </div>
            <h2>Neha<br><span>It should be good</span></h2>
        </div>
        <!-- messagesUser end -->
    </div>
    <!-- messages end -->
            </div>
            
    
            </main>            
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                fetch('/api/tasks/')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(projects => {
                        console.log('Fetched projects:', projects); // Debugging line to check the fetched data
            
                        // Check if projects array is valid
                        if (!Array.isArray(projects)) {
                            throw new Error('Invalid data format: projects is not an array');
                        }
            
                        // Filter projects based on their status
                        const projectProgressData = projects.map(project => {
                            let progress = 0;
                            if (project.status === 'done') {
                                progress = 100;
                            }
                            return {
                                name: project.name,
                                progress: progress
                            };
                        });
            
                        console.log('Processed project progress data:', projectProgressData); // Debugging line to check the processed data
            
                        // Ensure we have valid data to plot
                        if (projectProgressData.length === 0) {
                            throw new Error('No project data available to plot');
                        }
            
                        // Plot the completion percentage for each project
                        const data = {
                            x: projectProgressData.map(project => project.name),
                            y: projectProgressData.map(project => project.progress),
                            type: 'bar'
                        };
            
                        const layout = {
                            title: "Team tasks completion %",
                            xaxis: {
                                title: 'Projects'
                            },
                            yaxis: {
                                title: 'Completion %',
                                range: [0, 100]
                            }
                        };
            
                        Plotly.newPlot('project-progress-graph', [data], layout);
                    })
                    .catch(error => console.error('Error fetching or plotting projects:', error));
            });
            
            
            
            
            
            
            
            
            
                
            
            
            function changeMonth(monthChange) {
                const currentMonth = document.getElementById('current-month').innerText;
                const [month, year] = currentMonth.split(' ');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const currentMonthIndex = monthNames.indexOf(month);
                let newMonthIndex = currentMonthIndex + monthChange;
                let newYear = parseInt(year);
                if (newMonthIndex < 0) {
                    newMonthIndex = 11;
                    newYear--;
                } else if (newMonthIndex > 11) {
                    newMonthIndex = 0;
                    newYear++;
                }
                const newMonth = monthNames[newMonthIndex];
                document.getElementById('current-month').innerText = `${newMonth} ${newYear}`;
            
                // Clear the existing dates
                const daysList = document.querySelector('.days');
                daysList.innerHTML = '';
            
                // Get the number of days in the new month
                const daysInMonth = new Date(newYear, newMonthIndex + 1, 0).getDate();
            
                // Populate the days list with the dates for the new month
                for (let i = 1; i <= daysInMonth; i++) {
                    const listItem = document.createElement('li');
                    listItem.textContent = i;
                    daysList.appendChild(listItem);
                }
            }
            
            // Initial call to populate the calendar with dates for the current month
            changeMonth(0);
            
            
            document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/tasks/')
            .then(response => response.json())
            .then(tasks => {
                let taskTimelineData = tasks.map(task => ({
                    x: task.deadline,
                    y: task.name,
                    type: 'scatter',
                    mode: 'markers'
                }));
            
                Plotly.newPlot('task-timeline', taskTimelineData);
            })
            .catch(error => console.error('Error fetching tasks:', error));
            });
            
            
            
            
            document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/projects/')
                .then(response => response.json())
                .then(projects => {
                    let totalProgress = 0;
            
                    const projectPromises = projects.map(project =>
                        fetch(`/api/projects/${project.id}/progress/`)
                            .then(response => response.json())
                    );
            
                    Promise.all(projectPromises)
                        .then(progressDataArray => {
                            progressDataArray.forEach(progressData => {
                                totalProgress += progressData.progress;
                            });
            
                            // Calculate the overall completion percentage
                            const overallCompletionPercentage = totalProgress / projects.length;
            
                            // Render the overall completion percentage graph
                            Plotly.newPlot('project-completion-graph', [{
                                x: ['Overall Completion'],
                                y: [overallCompletionPercentage],
                                type: 'bar',
                                text: [`${overallCompletionPercentage.toFixed(2)}%`],
                                textposition: 'auto',
                                marker: {
                                    color: 'rgba(50,171,96,0.6)',
                                    line: {
                                        color: 'rgba(50,171,96,1.0)',
                                        width: 2
                                    }
                                }
                            }], {
                                title: 'Overall Project Completion Percentage',
                                yaxis: {
                                    range: [0, 100],
                                    title: 'Completion %'
                                }
                            });
                        })
                        .catch(error => console.error('Error fetching project progress:', error));
                })
                .catch(error => console.error('Error fetching projects:', error));
            });
            
            
            
            
            document.addEventListener('DOMContentLoaded', function() {
            Promise.all([
                fetch('/api/projects/').then(response => response.json()),
                fetch('/api/tasks/').then(response => response.json())
            ]).then(([projects, tasks]) => {
                // Extract task timelines from projects
                const taskTimelineData = projects.map(project => {
                    const tasksInProject = tasks.filter(task => task.project === project.id);
                    return {
                        projectId: project.id,
                        projectName: project.name,
                        tasks: tasksInProject.map(task => ({
                            taskId: task.id,
                            taskName: task.name,
                            startDate: task.start_date,
                            endDate: task.end_date,
                            deadline: task.deadline,
                            status: task.status
                        }))
                    };
                });
            
                // Plot the task timelines
                taskTimelineData.forEach(project => {
                    const projectTasks = project.tasks.map(task => ({
                        x: [task.startDate, task.endDate], // Use an array to support multiple traces
                        y: [task.taskName, task.taskName],
                        type: 'scatter',
                        mode: 'lines',
                        name: task.taskName, // Task name as trace name
                        line: {
                            width: 5 // Set line width for better visibility
                        }
                    }));
            
                    // Add markers for task deadlines and milestones
                    const markers = project.tasks.flatMap(task => {
                        const markerArray = [];
                        if (task.deadline) {
                            markerArray.push({
                                x: [task.deadline],
                                y: [task.taskName],
                                type: 'scatter',
                                mode: 'markers',
                                marker: {
                                    symbol: 'diamond',
                                    size: 8,
                                    color: 'green'
                                },
                                name: `${task.taskName} - Deadline`
                            });
                        }
                        if (task.status.toLowerCase() === 'done') {
                            markerArray.push({
                                y: [task.taskName],
                                type: 'scatter',
                                mode: 'markers',
                                marker: {
                                    symbol: 'star',
                                    size: 8,
                                    color: 'blue'
                                },
                                name: `${task.taskName} - Milestone`
                            });
                        }
                        return markerArray;
                    });
            
                    // Combine project tasks and markers
                    const combinedData = projectTasks.concat(markers);
            
                    // Add layout configuration
                    const layout = {
                        title: `${project.projectName} Task Timeline`,
                        xaxis: {
                            title: 'Date',
                            type: 'date', // Ensure the x-axis is treated as dates
                            tickformat: '%d-%m' // Format to display only day and month
                        },
                        yaxis: {
                        }
                    };
            
                    // Plot the task timeline for each project
                    Plotly.newPlot('task-timeline', combinedData, layout);
                });
            }).catch(error => console.error('Error fetching data:', error));
            });
        </script>

</body>
</html>